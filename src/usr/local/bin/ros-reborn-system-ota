#!/bin/bash

set -eo pipefail

REBORN_DIR="/rengeos-reborn"
TMP_DIR="${REBORN_DIR}/tmp"
OS_RELEASE="/etc/os-release"
TMP_OS_RELEASE="${TMP_DIR}/os-release"
GITHUB_REPO="RengeOS/ROS-Reborn-System-OTA"
LOG_FILE="/tmp/ros-reborn-system-ota.log"

log() {
	echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

error() {
	echo "[ERROR] $*" | tee -a "$LOG_FILE"
	if command -v dialog &>/dev/null; then
		dialog --title "Error" --msgbox "$*\n\nCheck log: $LOG_FILE" 12 70
	fi
	rm -rf "$TMP_DIR" 2>/dev/null || true
	exit 1
}

success() {
	echo "[SUCCESS] $*" | tee -a "$LOG_FILE"
}

info() {
	echo "[INFO] $*" | tee -a "$LOG_FILE"
}

log "ROS-Reborn-System-OTA started"
log "Log file: $LOG_FILE"

cleanup_on_exit() {
	local exit_code=$?
	log "Script exiting with code: $exit_code"

	rm -f /tmp/download_progress_$$_*.fifo 2>/dev/null || true

	pkill -P $$ dialog 2>/dev/null || true

	if [ $exit_code -ne 0 ]; then
		log "Script terminated with error - cleaning up temporary directory"
		rm -rf "$TMP_DIR" 2>/dev/null || true
	fi
}

trap cleanup_on_exit EXIT INT TERM

check_root() {
	log "Checking root privileges..."
	if [ "$EUID" -ne 0 ]; then
		log "ERROR: Script not running as root"
		error "This script must be run as root"
	fi
	log "Root privileges confirmed"
}

check_requirements() {
	log "Checking required tools..."
	local missing_tools=()

	for tool in dialog wget; do
		if ! command -v "$tool" &>/dev/null; then
			missing_tools+=("$tool")
			log "WARNING: Missing tool: $tool"
		fi
	done

	if [ ${#missing_tools[@]} -gt 0 ]; then
		log "ERROR: Missing required tools: ${missing_tools[*]}"
		error "Missing required tools: ${missing_tools[*]}\nPlease install: sudo pacman -S ${missing_tools[*]}"
	fi
	log "All required tools are available"
}

get_current_version() {
	log "Reading current version from $OS_RELEASE"
	if [ -f "$OS_RELEASE" ]; then
		source "$OS_RELEASE"
		log "Current version: ${IMAGE_VERSION:-Unknown}"
		echo "${IMAGE_VERSION:-Unknown}"
	else
		log "WARNING: $OS_RELEASE not found"
		echo "Unknown"
	fi
}

get_new_version() {
	log "Reading new version from $TMP_OS_RELEASE"
	if [ -f "$TMP_OS_RELEASE" ]; then
		source "$TMP_OS_RELEASE"
		log "New version: ${IMAGE_VERSION:-Unknown}"
		echo "${IMAGE_VERSION:-Unknown}"
	else
		log "WARNING: $TMP_OS_RELEASE not found"
		echo "Unknown"
	fi
}

download_all_release_files() {
	local tmp_dir="$1"

	log "Downloading all files from release using GitHub API..."
	log "Target directory: $tmp_dir"

	cd "$tmp_dir" || error "Failed to change to directory: $tmp_dir"

	local download_urls
	download_urls=$(wget -qO- "https://api.github.com/repos/${GITHUB_REPO}/releases/latest" | grep "browser_download_url" | cut -d '"' -f 4)

	if [ -z "$download_urls" ]; then
		log "ERROR: No files found in the latest release"
		error "No files found in the latest release."
	fi

	local url_array=()
	while IFS= read -r url; do
		[ -n "$url" ] && url_array+=("$url")
	done <<<"$download_urls"

	local total_files=${#url_array[@]}
	log "Found $total_files files to download"

	cleanup_pipes() {
		rm -f /tmp/download_progress_$$_*.fifo 2>/dev/null || true
	}
	trap cleanup_pipes EXIT

	local current_file=0
	for download_url in "${url_array[@]}"; do
		current_file=$((current_file + 1))
		local filename
		filename=$(basename "$download_url")
		log "Downloading file $current_file/$total_files: $filename"

		local fifo="/tmp/download_progress_$$_${current_file}.fifo"
		rm -f "$fifo" 2>/dev/null || true
		mkfifo "$fifo" || {
			log "ERROR: Failed to create FIFO $fifo"
			error "Failed to create progress pipe"
		}

		dialog --title "Downloading Files" --gauge "File: $filename ($current_file/$total_files)" 10 70 0 <"$fifo" &
		local dialog_pid=$!

		exec 3>"$fifo"

		local download_success=0
		(
			echo "0" >&3
			echo "XXX" >&3
			echo "Starting download: $filename" >&3
			echo "XXX" >&3

			if wget --progress=bar:force "$download_url" -O "$filename" 2>&1 |
				stdbuf -oL tr '\r' '\n' |
				stdbuf -oL grep -oP '[0-9]+(?=%)' |
				while read -r percent; do
					echo "$percent" >&3
					echo "XXX" >&3
					echo "Downloading $filename ($current_file/$total_files) - ${percent}%" >&3
					echo "XXX" >&3
				done; then
				echo "100" >&3
				echo "XXX" >&3
				echo "Download complete: $filename" >&3
				echo "XXX" >&3
				sleep 0.5
				exit 0
			else
				echo "0" >&3
				echo "XXX" >&3
				echo "Download failed: $filename" >&3
				echo "XXX" >&3
				sleep 1
				exit 1
			fi
		)
		download_success=$?

		exec 3>&-
		wait "$dialog_pid" 2>/dev/null || true
		rm -f "$fifo"

		if [ $download_success -ne 0 ] || [ ! -f "$filename" ]; then
			log "ERROR: Failed to download: $filename"
			error "Failed to download: $filename"
		fi

		log "Successfully downloaded: $filename ($(du -h "$filename" | cut -f1))"
	done

	trap - EXIT
	cleanup_pipes

	cd - >/dev/null || true
	log "Download completed successfully"
}

clear
check_root
check_requirements

CURRENT_VERSION=$(get_current_version)

log "Showing welcome dialog to user"
dialog --title "ROS-Reborn-System-OTA" --msgbox "Essentially, this is a tool for updating the backup system before ros-reborn uses it on the main system.\n\nIt will update the ros-reborn backup system to the latest version of the RengeOS ISO. It can help you install the latest RengeOS system with ros-reborn, ensuring you always use the newest version from the RengeOS ISO build, instead of the older version as before.\n" 16 70

log "Asking user confirmation to continue"
if ! dialog --title "Confirm" --yesno "Do you want to continue updating to the latest version?\nThe backup system update will only work in recovery mode and will not affect your data, so you are safe." 8 60; then
	log "User cancelled the update"
	clear
	echo "Update cancelled."
	exit 0
fi

log "User confirmed to continue"

dialog --infobox "Downloading latest system files..." 5 50
sleep 1

log "Creating temporary directory: $TMP_DIR"
dialog --infobox "Creating temporary directory..." 5 40
rm -rf "$TMP_DIR" 2>/dev/null || true
mkdir -p "$TMP_DIR" || error "Failed to create directory: $TMP_DIR"
log "Temporary directory created"

download_all_release_files "$TMP_DIR"

NEW_VERSION=$(get_new_version)

if [ "$NEW_VERSION" == "Unknown" ]; then
	log "ERROR: Unable to determine new version from downloaded os-release"
	rm -rf "$TMP_DIR"
	error "Unable to determine new version from downloaded os-release file."
fi

log "New version determined: $NEW_VERSION"

if [ "$CURRENT_VERSION" == "$NEW_VERSION" ]; then
	log "System is already on the latest version: $NEW_VERSION"
	dialog --title "Notice" --msgbox "System is already on the latest version: ${NEW_VERSION}" 8 60
	rm -rf "$TMP_DIR"
	clear
	exit 0
fi

log "Update available: $CURRENT_VERSION -> $NEW_VERSION"

log "Asking user for final confirmation"
if ! dialog --title "Confirm Update" --defaultno --yesno "Do you want to delete the current ros-reborn system version (${CURRENT_VERSION}) and replace it with the latest RengeOS version (${NEW_VERSION})?" 16 70; then
	log "User cancelled the final update confirmation"
	clear
	echo "Update cancelled."
	rm -rf "$TMP_DIR"
	exit 0
fi

log "User confirmed final update"
log "Starting update process..."

(
	echo "10"
	echo "XXX"
	echo "Deleting old airootfs..."
	echo "XXX"
	log "Deleting old airootfs from ${REBORN_DIR}/airootfs/"
	rm -rf "${REBORN_DIR}/airootfs/"*
	log "Old airootfs deleted"

	echo "30"
	echo "XXX"
	echo "Deleting old kernel..."
	echo "XXX"
	log "Deleting old kernel from ${REBORN_DIR}/kernel/"
	rm -rf "${REBORN_DIR}/kernel/"*
	log "Old kernel deleted"

	echo "50"
	echo "XXX"
	echo "Copying new airootfs.sfs..."
	echo "XXX"
	log "Copying new airootfs.sfs"
	if [ ! -d "${REBORN_DIR}/airootfs" ]; then
		mkdir -p "${REBORN_DIR}/airootfs"
		log "Created airootfs directory"
	fi

	airootfs_file=$(find "$TMP_DIR" -name "airootfs.sfs" -print -quit)
	if [ -n "$airootfs_file" ]; then
		mv "$airootfs_file" "${REBORN_DIR}/airootfs/"
		log "New airootfs.sfs copied successfully"
	else
		log "WARNING: airootfs.sfs not found in downloaded files"
	fi

	echo "70"
	echo "XXX"
	echo "Copying new kernel..."
	echo "XXX"
	log "Copying new kernel"
	if [ ! -d "${REBORN_DIR}/kernel" ]; then
		mkdir -p "${REBORN_DIR}/kernel"
		log "Created kernel directory"
	fi

	kernel_count=$(find "$TMP_DIR" -name "vmlinuz-*" | wc -l)
	if [ "$kernel_count" -gt 0 ]; then
		find "$TMP_DIR" -name "vmlinuz-*" -exec mv {} "${REBORN_DIR}/kernel/" \;
		log "Copied $kernel_count kernel file(s) successfully"
	else
		log "WARNING: No kernel files (vmlinuz-*) found in downloaded files"
	fi

	echo "85"
	echo "XXX"
	echo "Updating /etc/os-release..."
	echo "XXX"
	log "Replacing /etc/os-release with new version from $TMP_OS_RELEASE"
	if [ -f "$TMP_OS_RELEASE" ]; then
		rm -f "$OS_RELEASE"
		cp "$TMP_OS_RELEASE" "$OS_RELEASE"
		log "/etc/os-release replaced successfully"
	else
		log "WARNING: $TMP_OS_RELEASE not found, updating IMAGE_VERSION only"
		if grep -q "^IMAGE_VERSION=" "$OS_RELEASE" 2>/dev/null; then
			sed -i "/^IMAGE_VERSION=/d" "$OS_RELEASE"
		fi
		echo "IMAGE_VERSION=${NEW_VERSION}" >>"$OS_RELEASE"
	fi

	echo "95"
	echo "XXX"
	echo "Cleaning up..."
	echo "XXX"
	log "Removing temporary directory: $TMP_DIR"
	rm -rf "$TMP_DIR"
	log "Temporary directory removed"

	echo "100"
	echo "XXX"
	echo "Complete!"
	echo "XXX"
	sleep 1
) | dialog --title "Updating System" --gauge "Starting update process..." 10 70 0

log "Update process completed successfully"

dialog --title "Complete" --msgbox "Everything is complete!\n\nUpdated version from ${CURRENT_VERSION} to ${NEW_VERSION}.\n\nROS-Reborn system is ready to use.\n\nLog file: ${LOG_FILE}" 14 70

clear
log "Update completed successfully"
log "Old version: $CURRENT_VERSION"
log "New version: $NEW_VERSION"
success "Update successful!"
echo "Old version: ${CURRENT_VERSION}"
echo "New version: ${NEW_VERSION}"
echo "Log file: ${LOG_FILE}"

exit 0
